<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Login</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="stylesheet" href="compiled-assets/css/styles.css">
</head>

<body class="has-blue-background">

<div class="l-container">
    <div class="login--wrapper">
        <h1>Inloggen</h1>

        <form action="index.html">
            <ul class="login--form">
                <li>
                    <label for="email">E-mail</label>
                    <input id="email" type="text" />
                </li>
                <li>
                    <label for="password">Password</label>
                    <input id="password" type="password" />
                </li>
            </ul>


            <div class="login--actions">
                <a href="#">Wachtwoord vergeten?</a>
            </div>

            <div class="login--actions">
                <button type="submit" class="login--button">
                    Login
                    <i class="fa fa-chevron-right"></i>
                </button>
            </div>
        </form>

        <hr />

        <div class="login--actions">
            <div class="login--button" id="google-plus-signin-button">
                Google login
                <i class="fa fa-chevron-right"></i>
            </div>
            <div class="login--button" id="google-plus-logout-button">
                Google logout
                <i class="fa fa-chevron-right"></i>
            </div>
        </div>

    </div>
</div>
<script src="https://apis.google.com/js/api:client.js"></script>

<script type="text/javascript">


    /**
     * Google sign-in demo
     *
     * Make sure you have a an DJANGO OAUTH TOOLKIT `Application` created and change the backendClientId & secret.
     *
     * We should store the access_token for the user in local storage or similar and check if it is set and skip
     * the google login part and just try to get an refresh token. if that fails, we need a new login for the user
     * and clear the access_token. For demo purpose, the
     */
    gapi.load('auth2', function () {

        // Token for google
        var googleClientId = '197265624471-f8cb8sdb8dr1uevsscev16191ksr3ln6.apps.googleusercontent.com';

        // Client OAuth2 app created at backend
        var backendClientId = '1TZ7B0j54QPVxbDJSjEK4pAMoLhCP20pbTk7aT0V';

        // Google buttons
        var loginButton = document.getElementById("google-plus-signin-button");
        loginButton.style.display = 'none';
        var logoutButton = document.getElementById("google-plus-logout-button");
        logoutButton.style.display = 'none';

        // Setup Google plus sign-in
        var auth2 = gapi.auth2.init({
            client_id: googleClientId,
            scope: 'email'
        });

        auth2.then(function () {
            // Set click handlers on the buttons
            auth2.attachClickHandler(loginButton, {}, handleSignedInUser);
            logoutButton.onclick = handleLoggedOutUser;

            // When user is logged-in, use that user without touching google again,
            // otherwise show login button.
            if (auth2.isSignedIn.get()) {
                handleSignedInUser(auth2.currentUser.get());
            } else {
                loginButton.style.display = 'block';
            }
        });

        // Function is called when user returns from google login or has good session
        function handleSignedInUser(googleUser) {
            // Hide login button, show logout button.
            logoutButton.style.display = 'block';
            loginButton.style.display = 'none';

            // Get the access token that we can use to authenticate at backend
            var googleAccessToken = googleUser.getAuthResponse().access_token;

            getBackendAccessToken(googleAccessToken);

        }
            /**
             * Dummy for converting an google token to access & refresh tokens from backend.
             *
             * access token is valid for 1 hour, refresh token can be used to get a new access token.
             * to get a new access token, use:
             * grant_type=refresh_token&client_id=<client_id>&client_secret=<client_secret>&refresh_token=<your_refresh_token>
             */
        function getBackendAccessToken(googleToken) {
            var xmlhttp = new XMLHttpRequest();

            // Callback after sending xml request.
            xmlhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var myArr = JSON.parse(this.responseText);
                    // should have access & refresh tokens.
                    console.log(myArr);
                }
            };
            xmlhttp.open('POST', 'http://dockerhost:8005/api-social-auth/convert-token');
            xmlhttp.setRequestHeader('Accept', 'application/json');
            xmlhttp.setRequestHeader('Content-Type', 'application/json');
            var json = {
                'grant_type': 'convert_token',
                'client_id': backendClientId,
                'backend': 'google-plus',
                'token': googleToken
            };
            xmlhttp.send(JSON.stringify(json));
        }
        /**
         * Just tell the auth2 object to sign out. This should be the moment to clear access token & refresh token.
         */
        function handleLoggedOutUser() {

            event.preventDefault();
            auth2.signOut().then(function () {
                console.log("Logged out from Google+ platform");
                logoutButton.style.display = 'none';
                loginButton.style.display = 'block';
            });
        }
    });
</script>
</body>
</html>
